<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción de Datos GPS</title>
    <!-- Incluye las hojas de estilo de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Estilos CSS basados en tu primer código */
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        p {
            margin: 10px 0;
            color: #555;
        }

        strong {
            color: #333;
        }

        /* Estilo para el mapa Leaflet */
        #map {
            width: 90%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-top: 20px;
        }
        /* Estilo para la tabla */
        #infoTableContainer {
            max-height: 200px; /* Establece la altura máxima de la tabla */
            overflow-y: auto; /* Añade una barra de desplazamiento vertical si es necesario */
            margin-top: 20px; /* Espaciado superior para separar del mapa */
        } 
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
        }
    </style>
</head>

<body>
    <h1>Recepción de Datos de GPS</h1>
    <div class="container">
        <p id="latitud"><strong>Latitud:</strong> Cargando...</p>
        <p id="longitud"><strong>Longitud:</strong> Cargando...</p>
        <p id="fechaHora"><strong>Fecha y Hora:</strong> Cargando...</p>

        <!-- Agrega un contenedor para el mapa Leaflet -->
        <div id="map"></div>

        <!-- Agrega un botón para centrar el mapa en la ubicación actual -->
        <button id="centerMapButton">Centrar en mi Ubicación</button>
    </div>
    
        <!-- Calendario -->
        <label for="fechaInput">Selecciona una fecha:</label>
        <input type="date" id="fechaInput">

        <!-- Contenedor de la tabla -->
        <div id="infoTableContainer">
            <!-- Tabla para mostrar la información -->
            <table id="infoTable">
                <thead>
                    <tr>
                        <th>Latitud</th>
                        <th>Longitud</th>
                        <th>Fecha y Hora</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se llenará dinámicamente con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Incluye el script de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        // Variable para almacenar la última ubicación conocida
        var lastKnownLocation = null;
        var lastLatitude;
        var lastLongitude;



        // Función para calcular la distancia entre dos puntos geográficos (fórmula haversine)
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            var radLat1 = (Math.PI * lat1) / 180;
            var radLat2 = (Math.PI * lat2) / 180;
            var theta = lon1 - lon2;
            var radTheta = (Math.PI * theta) / 180;
            var dist =
                Math.sin(radLat1) * Math.sin(radLat2) +
                Math.cos(radLat1) * Math.cos(radLat2) * Math.cos(radTheta);
            dist = Math.acos(dist);
            dist = (dist * 180) / Math.PI;
            dist = dist * 60 * 1.1515; // En millas
            dist = dist * 1.609344; // En kilómetros
            return dist;
        }

        // Función para actualizar la ubicación en tiempo real
        function actualizarUbicacion(latitud, longitud, fechaHora) {
            // Actualiza los elementos HTML con los datos recibidos
            document.getElementById("latitud").innerText = `Latitud: ${latitud}`;
            document.getElementById("longitud").innerText = `Longitud: ${longitud}`;
            document.getElementById("fechaHora").innerText = `Fecha y Hora: ${fechaHora}`;

            // Actualiza el marcador en el mapa Leaflet
            marker.setLatLng([latitud, longitud]);

            //map.setView([latitud, longitud], 13);
            polyline.addLatLng([latitud, longitud]);
        }

        // Configura el mapa Leaflet
        var map = L.map('map').setView([0, 0], 13);
        var polyline = L.polyline([], { color: 'blue' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Crea un marcador y agrégalo al mapa
        var marker = L.marker([0, 0]).addTo(map);

        // Función para obtener la ubicación del usuario y actualizar si hay cambios significativos
        function obtenerUbicacionUsuario() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(function (position) {
                    var latitud = position.coords.latitude;
                    var longitud = position.coords.longitude;
                    var fechaHora = new Date().toLocaleString();

                    if (
                        !lastKnownLocation ||
                        calcularDistancia(lastKnownLocation.lat, lastKnownLocation.lng, latitud, longitud) > 0.01
                    ) {
                        lastKnownLocation = { lat: latitud, lng: longitud };

                        actualizarUbicacion(latitud, longitud, fechaHora);

                        map.setView([latitud, longitud], 13);
                    }
                }, function (error) {
                    console.error('Error al obtener la ubicación:', error);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            } else {
                console.log("Geolocalización no está disponible en este navegador.");
            }
        }

        document.getElementById("centerMapButton").addEventListener("click", function () {
            centerMap(lastLatitude, lastLongitude);
        });


        //Función que trae el ultimo dato de la db
        async function fetchUbicacionUltima() {
            try {
                const response = await fetch('/api/ubicaciones/ultimo');

                if (!response.ok) {
                    throw new Error('Error al obtener la ubicación más reciente');
                }

                const data = await response.json();
                const { latitude, longitude, time_stamp } = data;
                lastLatitude = latitude;
                lastLongitude = longitude;

                // Crear un objeto Date a partir del timestamp y establecer la zona horaria explícitamente
                const date = new Date(time_stamp);
                date.setUTCHours(date.getUTCHours() - 5); // Ajustar a GMT-5 (Bogotá)

                // Formatear la fecha y hora en el formato deseado (incluyendo la fecha)
                const formattedDate = date.toLocaleString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour12: true, // Usar formato de 12 horas (AM/PM)
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                actualizarUbicacion(latitude, longitude, formattedDate);
            } catch (error) {
                console.error('Error al obtener la ubicación más reciente:', error);
                // Maneja el error aquí si es necesario
            }
        }

        function centerMap(latitude, longitude) {
            map.setView([latitude, longitude], 13);
        }

        // Función para obtener la ubicación más reciente y centrar el mapa
        async function fetchAndCenterMap() {
            try {
                const response = await fetch('/api/ubicaciones/ultimo');

                if (!response.ok) {
                    throw new Error('Error al obtener la ubicación más reciente');
                }

                const data = await response.json();
                const { latitude, longitude } = data;
                console.log(latitude, longitude)
                lastLatitude = latitude;
                lastLongitude = longitude;
                // Centra el mapa en las coordenadas obtenidas
                centerMap(latitude, longitude);
            } catch (error) {
                console.error('Error al obtener la ubicación más reciente:', error);
                // Maneja el error aquí si es necesario
            }
        }





        // Función para obtener y actualizar la ubicación cada 5 segundos
        function obtenerYActualizarUbicacion() {
            fetchUbicacionUltima();
            setTimeout(obtenerYActualizarUbicacion, 5000);
        }

        obtenerYActualizarUbicacion();

        // Ejecuta la función cuando la página se carga completamente
        window.addEventListener('load', fetchAndCenterMap);

    // Función para buscar en la base de datos por fecha y hora
    async function buscarEnBaseDeDatos() {
        const fechaInput = document.getElementById('fechaInput').value;
        const formattedDate = new Date(fechaInput).toISOString();

        try {
            const response = await fetch(`/api/ubicaciones?fecha=${formattedDate}`);
            if (!response.ok) {
                throw new Error('Error al buscar en la base de datos');
            }

            const data = await response.json();
            mostrarInformacionEnTabla(data);
            trazarPolilinea(data);
        } catch (error) {
            console.error('Error al buscar en la base de datos:', error);
        }
    }

    function mostrarInformacionEnTabla(data) {
        const tableBody = document.querySelector('#infoTable tbody');
        tableBody.innerHTML = '';

        data.forEach((item) => {
            const row = tableBody.insertRow();
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            const cell3 = row.insertCell(2);

            cell1.textContent = item.latitude;
            cell2.textContent = item.longitude;

            // Convertir la hora a la zona horaria de Bogotá (GMT-5)
            const dateUTC = new Date(item.time_stamp);
            const dateBogota = new Date(dateUTC);
            dateBogota.setUTCHours(dateBogota.getUTCHours() - 5); // Ajustar a GMT-5 (Bogotá)

            // Formatear la fecha y hora en el formato deseado (incluyendo la fecha)
            const formattedDate = dateBogota.toLocaleString('es-CO', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour12: true, // Usar formato de 12 horas (AM/PM)
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            cell3.textContent = formattedDate;
        });
    }

    // Función para trazar la polilínea en el mapa
    function trazarPolilinea(data) {
        const coordinates = data.map((item) => [item.latitude, item.longitude]);
        polyline.setLatLngs(coordinates);
    }

    // Ejecuta la búsqueda y actualización al cambiar la fecha
    document.getElementById('fechaInput').addEventListener('change', buscarEnBaseDeDatos);
</script>
</body>

</html>
