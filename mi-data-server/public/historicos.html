<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de históricos</title>
    <!-- Incluye las hojas de estilo de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="style-historicos.css" />
    <style>
        /* Estilo para el infoBox */
        #infoBox {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            position: relative;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>

<body>
    <h1>CONSULTA DE HISTÓRICOS</h1>
    <div class="container">
        <!-- Agrega un contenedor para el mapa Leaflet -->
        <div class="container-izq">
            <div id="map"></div>

            <!-- Agrega un botón para centrar el mapa en la ubicación actual -->
            <a href="index.html"><button class="centerMapButton">RECEPCIÓN GPS</button></a>
        </div>

        <!-- Calendario -->
        <div class="container-der">
            <div class="container-tabla">
                <div class="calendar">
                    <label for="fechaInput">Selecciona una fecha de inicio:</label>
                    <input type="date" id="fechaInicial">
                    <label for="fechaInput">Selecciona una fecha de final:</label>
                    <input type="date" id="fechaFinal">
                    <button onclick="buscarEnBaseDeDatos()">Buscar</button>
                </div>
                <!-- Contenedor de la tabla -->
                <div id="infoTableContainer">
                    <!-- Tabla para mostrar la información -->
                    <table id="infoTable">
                        <thead>
                            <tr>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>Fecha y Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se llenará dinámicamente con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Div para mostrar la información del lugar -->
            <div id="infoBox">
                <h3>Información del lugar:</h3>
                <p id="infoText"></p>
            </div>
        </div>
    </div>

    <!-- Incluye el script de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([0, 0], 13);
        var polyline = L.polyline([], { color: 'blue' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        var marker = L.marker([0, 0]).addTo(map);

        // Variable global para almacenar los datos
        var data = [];

        async function centerMap(latitude, longitude) {
            map.setView([latitude, longitude], 13);
        }

        async function fetchAndCenterMap() {
            try {
                const response = await fetch('/api/ubicaciones/ultimo');

                if (!response.ok) {
                    throw new Error('Error al obtener la ubicación más reciente');
                }

                data = await response.json();
                const { latitude, longitude } = data;
                console.log(latitude, longitude)
                lastLatitude = latitude;
                lastLongitude = longitude;
                // Centra el mapa en las coordenadas obtenidas
                centerMap(latitude, longitude);
            } catch (error) {
                console.error('Error al obtener la ubicación más reciente:', error);
                // Maneja el error aquí si es necesario
            }
        }

        window.addEventListener('load', fetchAndCenterMap);

        async function buscarEnBaseDeDatos() {
            const fechaInicial = document.getElementById('fechaInicial').value;
            const fechaFinal = document.getElementById('fechaFinal').value;
            const formattedDateInicial = new Date(fechaInicial).toISOString();
            const formattedDateFinal = new Date(fechaFinal).toISOString();

            try {
                const response = await fetch(`/api/ubicaciones/por-rango-fechas?fechaInicio=${formattedDateInicial}&fechaFin=${formattedDateFinal}`);
                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }

                data = await response.json();
                if (data.message) {
                    throw new Error(data.message);
                }

                mostrarInformacionEnTabla(data);
                trazarPolilinea(data);

            } catch (error) {
                console.error('Error al buscar en la base de datos:', error.message);
                // Aquí puedes manejar el error de acuerdo a tus necesidades, por ejemplo, mostrar un mensaje al usuario
            }
        }

        // Define la función para mostrar información en la tabla
        function mostrarInformacionEnTabla(data) {
            const tabla = document.getElementById('tablaResultados');
            tabla.innerHTML = ''; // Limpia la tabla antes de agregar datos

            // Puedes iterar sobre 'data' y agregar filas a la tabla
            data.forEach((item) => {
                const fila = tabla.insertRow();
                // Agrega celdas a la fila y muestra la información que desees
            });
        }

        function mostrarInformacionEnTabla(data) {
            const tableBody = document.querySelector('#infoTable tbody');
            tableBody.innerHTML = '';

            data.forEach((item) => {
                const row = tableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                const cell3 = row.insertCell(2);

                cell1.textContent = item.latitude;
                cell2.textContent = item.longitude;

                // Convertir la hora a la zona horaria de Bogotá (GMT-5)
                const dateUTC = new Date(item.time_stamp);
                const dateBogota = new Date(dateUTC);
                dateBogota.setUTCHours(dateBogota.getUTCHours() - 5); // Ajustar a GMT-5 (Bogotá)

                // Formatear la fecha y hora en el formato deseado (incluyendo la fecha)
                const formattedDate = dateBogota.toLocaleString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour12: true, // Usar formato de 12 horas (AM/PM)
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                cell3.textContent = formattedDate;
            });
        }

        function trazarPolilinea(data) {
            const coordinates = data.map((item) => [item.latitude, item.longitude]);
            polyline.setLatLngs(coordinates);
        }

        // Añadimos la funcionalidad de dibujar un círculo en el mapa y buscar ubicaciones dentro de él
        var circle;

        map.on('click', function (e) {
            if (circle) {
                map.removeLayer(circle);
            }

            circle = L.circle(e.latlng, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 1000 // radio en metros
            }).addTo(map);

            // Actualizar el contenido del infoBox
            const infoText = `Latitud: ${e.latlng.lat.toFixed(6)}, Longitud: ${e.latlng.lng.toFixed(6)}, Hora: ${new Date().toLocaleTimeString()}`;
            document.getElementById('infoText').textContent = infoText;
            document.getElementById('infoBox').style.display = 'block'; // Mostrar el infoBox

            // Llamar a la función que busca ubicaciones dentro del círculo
            buscarUbicacionesEnCirculo(e.latlng.lat, e.latlng.lng);
        });


        async function buscarUbicacionesEnCirculo(latitud, longitud) {
            // Definir el radio del círculo en metros (debe coincidir con el radio del círculo dibujado en el mapa)
            const radioCirculo = 1000;
            const radioKm = radioCirculo/1000;

            try {
                // Construir la URL de la solicitud con los parámetros de query
                const url = `/api/ubicaciones/por-circulo?latitud=${latitud}&longitud=${longitud}&radio=${radioKm}`;

                // Realizar una solicitud AJAX al servidor para buscar ubicaciones dentro del círculo
                const response = await fetch(url, {
                    method: 'GET', // Utiliza el método HTTP GET para consultar
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Error en la solicitud');
                }

                const data = await response.json();
                console.log(data)
                // Procesar los resultados de la búsqueda, por ejemplo, mostrarlos en una lista o en el mapa
                trazarPolilinea(data);
            } catch (error) {
                console.error('Error al buscar ubicaciones en el círculo:', error);
                // Manejar el error de acuerdo a tus necesidades, por ejemplo, mostrar un mensaje al usuario
            }
        }

    </script>
</body>

</html>
